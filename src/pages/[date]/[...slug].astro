---
/**
 * [核心阅读器 (SSR Application Entry)]
 * ------------------------------------------------------------------
 * 功能：根据 URL 参数动态渲染文章阅读器，支持 L1/L2/L3 难度切换。
 *
 * 核心逻辑:
 * - Virtual Routing: 拦截 `/my-article/L2`，手动分离出 `slug`="my-article" 和 `level`=2。
 * - Cache Policy: 强制 `Cache-Control: private`。
 *   理由：Admin 用户和普通用户看到的页面包含不同数据 (Pull Quotes, Edits)，不能共享 CDN 缓存。
 * - Layout Dispatch: 根据 `generationMode` (RSS vs Impression) 动态分发不同的 Astro Layout。
 */
import Layout from "@/layouts/Layout.astro";
import ArticleHeader from "@/components/article/ArticleHeader.astro";
import WordSidebarAstro from "@/components/WordSidebar.astro";
import VisualTether from "@/components/VisualTether";
import FloatingAudioPlayer from "@/components/FloatingAudioPlayer";
import AudioInit from "@/components/AudioInit";
import HistoricalEchoes from "@/components/HistoricalEchoes";
import AdminStateInjector from "@/components/article/AdminStateInjector.astro";
import ImpressionArticleLayout from "@/components/impression/ImpressionArticleLayout.astro";
import ArticleDataInjectors from "@/components/article/ArticleDataInjectors.astro";

import "@/styles/article/shared.css";
import "@/styles/article/default.css";

import { 
    loadArticleBySlug, 
    buildWordMatchConfigs, 
    getReadingStats,
    getAllArticleContents 
} from "@/lib/articles/loader";
import { buildAnalysisTree } from "@/lib/features/syntax/AnnotationEngine";
import AnnotatedText from "@/components/analysis/AnnotatedText.astro";

// 解析 date 和 slug 参数
const { date, slug } = Astro.params;

// 路由解析逻辑
// slug 参数是贪婪匹配 (catch-all)，可能包含 "/L2"。
// 例如: slug = "my-article/L2" -> parts = ["my-article", "L2"]
// 我们需要分离出纯净的 'articleSlug' 和 'level'。
const slugParts = (slug || '').split('/');
const levelPart = slugParts[slugParts.length - 1]?.toUpperCase();
const isLevelParam = ['L1', 'L2', 'L3'].includes(levelPart);

const articleSlug = isLevelParam 
    ? slugParts.slice(0, -1).join('/') // 移除末尾的等级标识
    : slugParts.join('/'); 

const initialLevel = isLevelParam
    ? parseInt(levelPart.replace('L', ''))
    : 1;

if (!date || !articleSlug) {
    return Astro.redirect('/');
}

// 服务端获取文章数据
const articleData = await loadArticleBySlug(date, articleSlug);

if (!articleData) {
    Astro.response.headers.set('Cache-Control', 'no-store');
    // Consider redirecting to 404 page properly
    return Astro.redirect('/404');
}

// 解构数据
const {
    row,
    sources,
    wordDefinitions,
    sidebarWords,
    dateLabel,
    sortedArticles,
    title,
    category,
    readLevels,
    echoes,
    generationMode,
} = articleData;

const id = row?.articles?.id; // Needed for client side logic


// 管理员状态 (From Middleware)
const { isAdmin, preferences } = Astro.locals.auth;

// [Logic] Determine Layout Mode
// Priority: Cookie (Admin Only) > GenerationMode > Default
let userStyle = null;
if (isAdmin && preferences.readingStyles) {
    userStyle = preferences.readingStyles[generationMode];
}

// 2. Fallback
const targetStyle = userStyle || (generationMode === 'impression' ? 'impression' : 'default');
const showImpression = targetStyle === 'impression';

// If Impression Mode, render specialized layout immediately
if (showImpression) {
   // Pass all props needed
   // Note: We return early to render the Impression Layout
}

// 构建单词匹配配置 (用于 SSR 单词高亮)
const wordMatchConfigs = buildWordMatchConfigs(wordDefinitions);

// 获取所有文章内容用于 AudioPlayer
const allArticleContents = getAllArticleContents(sortedArticles);


---

<Layout title={`${title} - UpWord`}>
    {/* Server Island: Inject Admin State asynchronously to allow caching main content */}
    <AdminStateInjector server:defer />

    {showImpression ? (
        <ImpressionArticleLayout 
            articleData={articleData} 
            initialLevel={initialLevel}
        />
    ) : (
    <div data-article-page class="default-mode grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-10 mx-auto w-full max-w-7xl px-4 py-10">
        <!-- 主内容区 -->
        <div 
            class={`relative min-w-0 ${sidebarWords.length === 0 ? "max-w-3xl mx-auto" : ""}`}
            data-article-id={id}
            data-read-levels={readLevels}
            data-is-admin="false" 
            transition:animate="slide"
        >
            <div class="space-y-8">
                <!-- Data Injection (SSR -> Client Store) -->
                <ArticleDataInjectors echoes={echoes} />

                <!-- 文章容器 (去卡片化) -->
                <div class="md:px-2">
                    <!-- 文章头部 -->
                    <!-- 文章头部 -->
                    <ArticleHeader 
                        title={title}
                        dateLabel={dateLabel}
                        category={category}
                        initialLevel={initialLevel}
                        backHref={`/day/${row?.tasks?.taskDate || ''}`}
                    />
                    
                    <!-- 三个难度的文章内容 -->
                    <article id="article-content" class="font-serif leading-loose text-lg text-slate-800/90 md:text-xl animate-enter-content">
                        {sortedArticles.map((article: any) => {
                            const stats = getReadingStats(article.content);
                            
                            // [Analysis] Build AST with paragraphs and word highlighting
                            const paragraphs = buildAnalysisTree(
                                article.content || '',
                                article.sentences || [],
                                article.syntax || [],
                                wordMatchConfigs
                            );

                            return (
                                <div
                                    class="article-level"
                                    data-level={article.level}
                                    data-word-count={stats.wordCount}
                                    data-minutes={stats.minutes}
                                    data-active={article.level === initialLevel ? "" : undefined}
                                >
                                    {/* [NEW] Summary Display (L2/L3) */}
                                    {article.summary && (
                                        <div class="mb-10 text-2xl font-serif italic text-stone-600 leading-relaxed border-l-4 border-amber-600 pl-6 py-2">
                                            {article.summary}
                                        </div>
                                    )}

                                    {paragraphs.map((blockNodes: any[], pIndex: number) => {
                                        // [NEW] Pull Quote Logic (After 2nd paragraph)
                                        const isPullQuotePos = pIndex === 1 && article.pullQuote;

                                        return (
                                            <>
                                                <p class="mb-6 indent-8">
                                                    <AnnotatedText nodes={blockNodes} />
                                                </p>
                                                
                                                {isPullQuotePos && (
                                                    <blockquote class="border-l-2 border-slate-800 pl-6 italic text-slate-600 my-10 text-2xl font-serif leading-relaxed">
                                                        "{article.pullQuote}"
                                                    </blockquote>
                                                )}
                                            </>
                                        );
                                    })}
                                </div>
                            );
                        })}
                    </article>
                </div>
                
                <!-- 来源 -->
                {sources.length > 0 && (
                    <div id="article-sources" class="pt-8 mt-8 border-t border-slate-900/10">
                        <div class="text-[10px] font-bold uppercase tracking-widest text-stone-500 mb-4">
                            Sources
                        </div>
                        <ul class="space-y-1">
                            {sources.map((url) => {
                                let domain = url;
                                try {
                                    domain = new URL(url).hostname.replace(/^www\./, "");
                                } catch {}
                                return (
                                    <li class="flex items-center gap-2">
                                        <span class="w-1 h-1 rounded-full bg-stone-300" />
                                        <a
                                            href={url}
                                            target="_blank"
                                            rel="noreferrer"
                                            class="text-xs font-serif text-stone-500 hover:text-slate-900 underline decoration-stone-300 underline-offset-4 hover:decoration-slate-900 transition-all"
                                            title={url}
                                        >
                                            {domain}
                                        </a>
                                    </li>
                                );
                            })}
                        </ul>
                    </div>
                )}
                
                <VisualTether client:only="react" />
            </div>
            
            <!-- Historical Echoes (Replaces MemorySpirit & HighlightManager) -->
            <HistoricalEchoes client:idle articleId={id} />
        </div>
        
        <!-- 侧边栏 -->
        {sidebarWords.length > 0 && (
            <aside class="lg:w-80 lg:shrink-0">
                <div class="lg:sticky lg:top-6 space-y-4">
                    <AudioInit 
                        client:idle 
                        allContent={allArticleContents} 
                        articleId={id || ""} 
                    />
                    <FloatingAudioPlayer client:only="react" />
                    <WordSidebarAstro words={sidebarWords} articleId={id} />
                </div>
            </aside>
        )}
    </div>
    )}
</Layout>



<script>
import { initLevelSwitcher } from '../../lib/features/reading/levelSwitcher';
import { initReadTracker, trackReading } from '../../lib/features/reading/readTracker';
import { initSyntaxController } from '../../lib/features/syntax/SyntaxController';
import { initEchoes } from '../../lib/store/interactionStore';
import { initHoverController } from '../../lib/features/echoes/hoverController';

// 仅在 Default Mode 下初始化这些功能
// Impression Mode 有自己的独立初始化逻辑 (见 ImpressionArticleLayout.astro)
function initArticlePage() {
    const isDefaultMode = !!document.querySelector('.default-mode');
    if (!isDefaultMode) return;

    // [New] 注入 Echoes 数据到 Store (Single Source of Truth)
    try {
        const dataEl = document.getElementById('memories-data');
        if (dataEl && dataEl.textContent) {
            const echoes = JSON.parse(dataEl.textContent);
            initEchoes(echoes);
        }
    } catch (e) {
        console.error("Failed to init echoes", e);
    }

    // 初始化难度切换
    initLevelSwitcher();
    
    // 初始化阅读追踪
    initReadTracker();
    
    // 监听难度变化以触发阅读追踪
    window.addEventListener('level-change', () => {
        trackReading();
    });
    
    // [New] 初始化历史回响交互控制器 (Event Delegation)
    // Default Mode: Hover to trigger
    initHoverController();
}


/**
 * 初始化复制原文按钮
 * 复制当前难度等级的文章原文，保留段落格式
 */


/**
 * 初始化目标单词交互 - 仅保留朗读功能
 * Hover 功能已移至 initHoverController (Event Delegation)
 * 仅在 Default Mode 生效 (Impression Mode 下点击触发 Popover)
 */
function initTargetWordInteraction() {
    const isDefaultMode = !!document.querySelector('.default-mode');
    if (!isDefaultMode) return;

    document.querySelectorAll('.target-word').forEach((el) => {
        el.addEventListener('click', (e) => {
            const word = el.getAttribute('data-word');
            if (!word) return;
            
            e.stopPropagation();
            const u = new SpeechSynthesisUtterance(word);
            u.lang = 'en-US';
            speechSynthesis.speak(u);
        });
    });
}

// 支持普通页面加载和 View Transitions
document.addEventListener('DOMContentLoaded', initArticlePage);
document.addEventListener('astro:page-load', initArticlePage);

// Analysis Interaction (仅限 Default Mode)
document.addEventListener('DOMContentLoaded', () => {
    if (document.querySelector('.default-mode')) initSyntaxController();
});
document.addEventListener('astro:page-load', () => {
    if (document.querySelector('.default-mode')) initSyntaxController();
});

// Target Word Interaction (Click to Speak only - Default Mode)
document.addEventListener('DOMContentLoaded', initTargetWordInteraction);
document.addEventListener('astro:page-load', initTargetWordInteraction);
</script>
