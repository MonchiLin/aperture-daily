---
/**
 * 文章页 - SSR 渲染
 * 
 * 三个难度级别的内容都在 HTML 中输出，用 CSS 控制显示/隐藏。
 * 难度切换使用极简的原生 JavaScript，无需 React。
 * 高亮功能作为独立 Island 延迟加载。
 */
import Layout from "@/layouts/Layout.astro";
import WordSidebarAstro from "@/components/WordSidebar.astro";
import HighlightManager from "@/components/HighlightManager";
import VisualTether from "@/components/VisualTether";
import AudioPlayer from "@/components/AudioPlayer";
import AudioInit from "@/components/AudioInit";
import MemorySpirit from "@/components/MemorySpirit";
import AIAnalyzer from "@/components/AIAnalyzer";
import { apiFetch } from "@/lib/api";
import {
    extractSources,
    extractWordDefinitions,
    formatDateLabel,
    mapToSidebarWords,
    parseArticleContent,
} from "@/lib/articles/utils";
import { injectStructureSpans } from "@/lib/structure/injector";
import type { ArticleParsedContent } from "@/lib/articles/types";

const { id } = Astro.params;

if (!id) {
    return Astro.redirect('/');
}

// 服务端获取文章数据
let row: any = null;
let parsed: ArticleParsedContent = {};
let sources: string[] = [];
let wordDefinitions: any[] = [];
let sidebarWords: any[] = [];
let dateLabel = "";

try {
    row = await apiFetch(`/api/articles/${id}`);
    if (row?.articles?.content_json) {
        parsed = parseArticleContent(row.articles.content_json);
        sources = extractSources(parsed);
        wordDefinitions = extractWordDefinitions(parsed);
        sidebarWords = mapToSidebarWords(wordDefinitions);
        dateLabel = formatDateLabel(row.tasks?.task_date);
        // ISR 策略：CDN 缓存 1 天 (s-maxage)，过期后先返回旧内容 (stale) 并在后台异步刷新 (revalidate)
        Astro.response.headers.set('Cache-Control', 'public, s-maxage=86400, stale-while-revalidate=31536000');
    }
} catch (e: any) {
    console.error("[SSR] Failed to fetch article:", e.message);
    // 错误情况，禁止缓存
    Astro.response.headers.set('Cache-Control', 'no-store');
    if (e.message?.includes("404") || e.message?.includes("Not found")) {
        Astro.response.status = 404;
    }
}

// 获取三个难度级别的文章
const articles = parsed?.result?.articles || [];
const sortedArticles = [...articles].sort((a: any, b: any) => a.level - b.level);
const title = row?.articles?.title || "Article";

// 获取所有文章内容用于 AudioPlayer（按难度合并）
const allArticleContents = sortedArticles.map((a: any) => ({
    level: a.level,
    content: a.content || ''
}));

// 计算阅读统计
function getReadingStats(content: string) {
    const words = content?.trim().split(/\s+/).filter(Boolean) || [];
    const count = words.length;
    const minutes = count ? Math.max(1, Math.ceil(count / 120)) : 0;
    return { wordCount: count, minutes };
}

// 目标单词列表
const targetWords = sidebarWords.map((w: any) => w.word.toLowerCase());

// [Semantic Weaving] Pre-fetch memories (SSR Batch)
let initialMemories = {};
if (targetWords.length > 0) {
    try {
        const authKey = Astro.cookies.get('admin_key')?.value || import.meta.env.ADMIN_KEY;

        const data = await apiFetch<{ memories?: Record<string, unknown> }>('/api/context/batch', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authKey}`
            },
            body: JSON.stringify({
                words: targetWords,
                exclude_article_id: id
            })
        });
        
        initialMemories = data?.memories || {};
    } catch (e) {
        console.error("Failed to fetch memories:", e);
    }
}
---

<Layout title={`${title} - Aperture Daily`}>
    {row ? (
        <div class="grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-10 mx-auto w-full max-w-7xl px-4 py-10">
            <!-- 主内容区 -->
            <main class={`relative min-w-0 ${sidebarWords.length === 0 ? "max-w-3xl mx-auto" : ""}`}>
                <div class="space-y-8">
                    <!-- 文章容器 -->
                    <div class="bg-white rounded-3xl border border-gray-100 p-6 md:p-8">
                        <!-- 文章头部 -->
                        <header class="mb-6 md:mb-8">
                            <div class="flex items-center justify-between text-xs md:text-sm font-bold tracking-widest uppercase text-stone-500 mb-4 border-b border-slate-900 pb-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-slate-900">{dateLabel}</span>
                                    <span class="text-stone-300">|</span>
                                    <span id="reading-time">Loading...</span>
                                </div>
                                
                                <!-- 难度切换器 -->
                                <div class="flex gap-1" id="level-switcher">
                                    {[1, 2, 3].map((level) => (
                                        <button
                                            type="button"
                                            data-level-btn={level}
                                            class:list={[
                                                "level-btn w-8 h-6 flex items-center justify-center text-xs font-bold transition-all rounded-sm border leading-none",
                                                level === 1 
                                                    ? "bg-slate-900 text-white border-slate-900" 
                                                    : "bg-transparent text-stone-400 border-transparent hover:border-stone-200 hover:text-stone-600"
                                            ]}
                                        >
                                            L{level}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <h1 class="text-3xl md:text-5xl font-bold text-slate-900 tracking-tight leading-[1.1] font-display">
                                {title}
                            </h1>
                        </header>
                        
                        <!-- 三个难度的文章内容 -->
                        <article id="article-content" class="font-serif leading-loose text-lg text-slate-800/90 md:text-xl">
                            {sortedArticles.map((article: any) => {
                                const stats = getReadingStats(article.content);
                                
                                // [Structure] Inject Standoff Markup
                                let contentHtml = article.content || '';
                                if (article.structure && article.structure.length > 0) {
                                    try {
                                        contentHtml = injectStructureSpans(article.content, article.structure);
                                    } catch (e) {
                                        console.error("[Structure] Injection failed:", e);
                                    }
                                }

                                const paragraphs = contentHtml.split('\n').filter((p: string) => p.trim()) || [];
                                
                                return (
                                    <div
                                        class="article-level"
                                        data-level={article.level}
                                        data-word-count={stats.wordCount}
                                        data-minutes={stats.minutes}
                                    >
                                        {paragraphs.map((paragraph: string, pIndex: number) => (
                                            <p 
                                                class={`mb-6 text-justify ${pIndex === 0 ? 'drop-cap-p' : 'indent-8'}`}
                                                set:html={paragraph}
                                            />
                                        ))}
                                    </div>
                                );
                            })}
                        </article>
                    </div>
                    
                    <!-- 来源 -->
                    {sources.length > 0 && (
                        <div id="article-sources" class="pt-8 mt-8 border-t border-slate-900/10">
                            <div class="text-[10px] font-bold uppercase tracking-widest text-stone-500 mb-4">
                                Sources
                            </div>
                            <ul class="space-y-1">
                                {sources.map((url) => {
                                    let domain = url;
                                    try {
                                        domain = new URL(url).hostname.replace(/^www\./, "");
                                    } catch {}
                                    return (
                                        <li class="flex items-center gap-2">
                                            <span class="w-1 h-1 rounded-full bg-stone-300" />
                                            <a
                                                href={url}
                                                target="_blank"
                                                rel="noreferrer"
                                                class="text-xs font-serif text-stone-500 hover:text-slate-900 underline decoration-stone-300 underline-offset-4 hover:decoration-slate-900 transition-all"
                                                title={url}
                                            >
                                                {domain}
                                            </a>
                                        </li>
                                    );
                                })}
                            </ul>
                        </div>
                    )}
                    
                    <VisualTether client:only="react" />
                </div>
                
                <!-- [New] Memory Spirit (Floating Echo) -->
                <MemorySpirit client:load />

                <!-- 高亮管理器 - 作为独立 Island 加载 -->
                <HighlightManager 
                    client:load 
                    articleId={id} 
                    targetWords={targetWords}
                    memoriesMap={initialMemories}
                />
                
                <!-- AI 选词分析器 -->
                <AIAnalyzer 
                    client:idle 
                    articleContent={sortedArticles[0]?.content || ''} 
                />
            </main>
            
            <!-- 侧边栏 - 音频 + 词汇 -->
            {sidebarWords.length > 0 && (
                <aside class="lg:w-80 lg:shrink-0">
                    <div class="lg:sticky lg:top-6 space-y-4">
                        <!-- Audio 初始化器（传递所有难度的内容） -->
                        <AudioInit 
                            client:idle 
                            allContent={allArticleContents} 
                        />
                        
                        <!-- Audio Edition (组件自带标题) -->
                        <AudioPlayer client:only="react" />

                        <!-- Margin Notes -->
                        <WordSidebarAstro words={sidebarWords} />
                    </div>
                </aside>
            )}
        </div>
    ) : (
        <div class="mx-auto w-full max-w-7xl px-4 py-10">
            <div class="rounded-xl border border-black/10 bg-white/60 p-5 text-sm opacity-70">
                该文章不存在或未发布。
            </div>
        </div>
    )}
</Layout>

<style is:global>
    /* 强力覆盖：确保朗读时的高亮优先级最高 */
    span.w-token.bg-orange-200 {
        background-color: #fed7aa !important; /* orange-200 */
        color: #7c2d12 !important; /* orange-900 */
        box-shadow: 0 0 0 2px #fed7aa; /* 稍微扩散背景以确保可见性 */
        border-radius: 2px;
        position: relative;
        z-index: 10;
    }
</style>

<style>
    /* 默认只显示 Level 1 */
    .article-level {
        opacity: 0;
        visibility: hidden;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        transition: opacity 0.5s ease;
        z-index: 1;
        pointer-events: none;
    }
    .article-level[data-active] {
        opacity: 1;
        visibility: visible;
        position: relative;
        z-index: 2;
        pointer-events: auto;
    }
    
    /* 容器动画 */
    #article-content {
        position: relative;
        transition: height 0.5s ease;
        /* 防止高度塌陷时的抖动 */
        min-height: 200px; 
    }
    
    /* 难度按钮激活状态 */
    .level-btn[data-active] {
        background-color: rgb(15 23 42); /* slate-900 */
        color: white;
        border-color: rgb(15 23 42);
    }
    
    /* 目标单词高亮 */
    .target-word {
        color: #ea580c;
        font-weight: 600;
        border-bottom: 2px dotted #ea580c;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
    }

    /* Golden Soul Pin - Words with History */
    .target-word[data-has-history="true"] {
        border-bottom-color: #f59e0b; /* Amber-500 */
    }
    
    .target-word[data-has-history="true"]::after {
        content: '';
        position: absolute;
        top: -2px;
        right: -4px;
        width: 4px;
        height: 4px;
        background: #fbbf24;
        border-radius: 99px;
        box-shadow: 0 0 8px rgba(251, 191, 36, 0.6);
        opacity: 0.8;
    }
</style>

<script>
    // 极简的难度切换逻辑
    // 使用 astro:page-load 以支持 View Transitions
    function initLevelSwitcher() {
        const levels = document.querySelectorAll('.article-level');
        const buttons = document.querySelectorAll('[data-level-btn]');
        const readingTimeEl = document.getElementById('reading-time');
        
        // 如果没有找到元素，说明不在文章页
        if (levels.length === 0 || buttons.length === 0) return;
        
        function setLevel(level: number) {
            // 切换内容显示
            // 使用 Grid Layer 或 Absolute Position 过渡
            // 简单方案：计算高度并设置
            
            const container = document.getElementById('article-content');
            
            levels.forEach(el => {
                const elLevel = parseInt(el.getAttribute('data-level') || '0');
                if (elLevel === level) {
                    el.setAttribute('data-active', '');
                    
                    // 更新阅读时间
                    const minutes = el.getAttribute('data-minutes') || '1';
                    if (readingTimeEl) {
                        readingTimeEl.textContent = `${minutes} ${parseInt(minutes) === 1 ? 'minute' : 'minutes'}`;
                    }
                } else {
                    el.removeAttribute('data-active');
                }
            });
            
            // 手动设置容器高如果是 absolute 定位方案 (我们用的是 relative toggle, 但为了 smooth height，还是需要 trick)
            // 修改了 CSS 为 absolute overlay? 不，文章太长，absolute 会导致 footer 上浮。
            // 最佳方案：
            // A (Old) -> Fade Out (Absolute)
            // B (New) -> Fade In (Relative)
            // Container -> Animate Height
            
            // 为了简单且效果好：
            // 1. 获取新层的高度，直接设置给 Container
             // Trick: 我们先让它 block (but opacity 0) 来测量? 
            // 现在的 CSS .article-level[data-active] 是 relative + visible
            // 非 active 是 absolute + hidden
            
            // 在 React/Vue 中我们会用 FLIP，这里手动：
            // 由于 active 变为 relative，它撑开了父容器，会有自动的高度变化吗？
            // transition: height 需要明确的 height 值。
            
            // 重新测量 active element 的高度
             const activeEl = document.querySelector(`.article-level[data-level="${level}"]`);
             if (activeEl && container) {
                 // 此时它已经 relative 了，所以 container 理论上已经被撑开
                 // 但我们要动画...
                 // 方案：先锁定 container 高度为当前高度
                 // const currentH = container.offsetHeight;
                 // container.style.height = `${currentH}px`;
                 // ... switch class ...
                 // const newH = activeEl.offsetHeight;
                 // container.style.height = `${newH}px`;
                 // setTimeout(() => container.style.height = 'auto', 500);
             }
            
            // 切换按钮状态
            buttons.forEach(btn => {
                const btnLevel = parseInt(btn.getAttribute('data-level-btn') || '0');
                if (btnLevel === level) {
                    btn.setAttribute('data-active', '');
                    btn.classList.add('bg-slate-900', 'text-white', 'border-slate-900');
                    btn.classList.remove('bg-transparent', 'text-stone-400', 'border-transparent');
                } else {
                    btn.removeAttribute('data-active');
                    btn.classList.remove('bg-slate-900', 'text-white', 'border-slate-900');
                    btn.classList.add('bg-transparent', 'text-stone-400', 'border-transparent');
                }
            });
            
            // 保存到 localStorage
            try {
                localStorage.setItem('aperture-daily_preferred_level', String(level));
            } catch {}

            // Dispatch event for React components
            window.dispatchEvent(new CustomEvent('level-change', { detail: { level } }));
        }
        
        // 绑定点击事件
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const level = parseInt(btn.getAttribute('data-level-btn') || '1');
                setLevel(level);
            });
        });
        
        // 恢复上次选择的难度
        let initialLevel = 1;
        try {
            const saved = localStorage.getItem('aperture-daily_preferred_level');
            if (saved) initialLevel = parseInt(saved) || 1;
        } catch {}
        
        // 确保有效范围
        if (initialLevel < 1 || initialLevel > 3) initialLevel = 1;
        
        // 初始化
        setLevel(initialLevel);
    }
    
    // 支持普通页面加载和 View Transitions SPA 导航
    document.addEventListener('DOMContentLoaded', initLevelSwitcher);
    document.addEventListener('astro:page-load', initLevelSwitcher);

    // [Feature] Structure Reveal
    import { initStructureInteraction } from '../../lib/features/structure/interaction';

    // Init on page load
    document.addEventListener('DOMContentLoaded', initStructureInteraction);
    document.addEventListener('astro:page-load', initStructureInteraction);
</script>
