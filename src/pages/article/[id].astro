---
/**
 * æ–‡ç« é¡µ - SSR æ¸²æŸ“
 * 
 * ä¸‰ä¸ªéš¾åº¦çº§åˆ«çš„å†…å®¹éƒ½åœ¨ HTML ä¸­è¾“å‡ºï¼Œç”¨ CSS æ§åˆ¶æ˜¾ç¤º/éšè—ã€‚
 * éš¾åº¦åˆ‡æ¢ä½¿ç”¨æç®€çš„åŸç”Ÿ JavaScriptï¼Œæ— éœ€ Reactã€‚
 * é«˜äº®åŠŸèƒ½ä½œä¸ºç‹¬ç«‹ Island å»¶è¿ŸåŠ è½½ã€‚
 * 
 * ğŸ”§ é€»è¾‘å·²æ‹†åˆ†åˆ°:
 *   - lib/articles/loader.ts - æ•°æ®åŠ è½½
 *   - lib/features/levelSwitcher.ts - éš¾åº¦åˆ‡æ¢
 *   - lib/features/readTracker.ts - é˜…è¯»è¿½è¸ª
 */
import Layout from "@/layouts/Layout.astro";
import WordSidebarAstro from "@/components/WordSidebar.astro";
import HighlightManager from "@/components/HighlightManager";
import VisualTether from "@/components/VisualTether";
import FloatingAudioPlayer from "@/components/FloatingAudioPlayer";
import AudioInit from "@/components/AudioInit";
import MemorySpirit from "@/components/MemorySpirit";

import { 
    loadArticle, 
    buildWordMatchConfigs, 
    getReadingStats,
    getAllArticleContents 
} from "@/lib/articles/loader";
import { StructureParser, splitASTIntoBlocks } from "@/lib/structure/parser";
import StructuredText from "@/components/structure/StructuredText.astro";

const { id } = Astro.params;

if (!id) {
    return Astro.redirect('/');
}

// æœåŠ¡ç«¯è·å–æ–‡ç« æ•°æ®
const articleData = await loadArticle(id);

if (!articleData) {
    Astro.response.headers.set('Cache-Control', 'no-store');
    Astro.response.status = 404;
}

// è§£æ„æ•°æ®
const {
    row,
    sources,
    wordDefinitions,
    sidebarWords,
    dateLabel,
    sortedArticles,
    title,
    readLevels,
    memories,
} = articleData || {
    row: null,
    sources: [],
    wordDefinitions: [],
    sidebarWords: [],
    dateLabel: '',
    sortedArticles: [],
    title: 'Article',
    readLevels: 0,
    memories: {},
};

// è®¾ç½®ç¼“å­˜
if (row) {
    Astro.response.headers.set('Cache-Control', 'public, s-maxage=86400, stale-while-revalidate=31536000');
}

// ç›®æ ‡å•è¯åˆ—è¡¨
const targetWords = sidebarWords.map((w: any) => w.word.toLowerCase());

// æ„å»ºå•è¯åŒ¹é…é…ç½®
const wordMatchConfigs = buildWordMatchConfigs(wordDefinitions);

// è·å–æ‰€æœ‰æ–‡ç« å†…å®¹ç”¨äº AudioPlayer
const allArticleContents = getAllArticleContents(sortedArticles);

// ç®¡ç†å‘˜çŠ¶æ€
const adminKey = Astro.cookies.get('admin_key')?.value;
const isAdmin = !!adminKey;
---

<Layout title={`${title} - Aperture Daily`}>
    {row ? (
        <div class="grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-10 mx-auto w-full max-w-7xl px-4 py-10">
            <!-- ä¸»å†…å®¹åŒº -->
            <main 
                class={`relative min-w-0 ${sidebarWords.length === 0 ? "max-w-3xl mx-auto" : ""}`}
                data-article-id={id}
                data-read-levels={readLevels}
                data-is-admin={isAdmin ? "true" : "false"}
            >
                <div class="space-y-8">
                    <!-- æ–‡ç« å®¹å™¨ -->
                    <div class="bg-white rounded-3xl border border-gray-100 p-6 md:p-8">
                        <!-- æ–‡ç« å¤´éƒ¨ -->
                        <header class="mb-6 md:mb-8">
                            <div class="flex items-center justify-between text-xs md:text-sm font-bold tracking-widest uppercase text-stone-500 mb-4 border-b border-slate-900 pb-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-slate-900">{dateLabel}</span>
                                    <span class="text-stone-300">|</span>
                                    <span id="reading-time">Loading...</span>
                                </div>
                                
                                <!-- éš¾åº¦åˆ‡æ¢å™¨ -->
                                <div class="flex gap-1" id="level-switcher">
                                    {[1, 2, 3].map((level) => (
                                        <button
                                            type="button"
                                            data-level-btn={level}
                                            class:list={[
                                                "level-btn w-8 h-6 flex items-center justify-center text-xs font-bold transition-all rounded-sm border leading-none",
                                                level === 1 
                                                    ? "bg-slate-900 text-white border-slate-900" 
                                                    : "bg-transparent text-stone-400 border-transparent hover:border-stone-200 hover:text-stone-600"
                                            ]}
                                        >
                                            L{level}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <h1 class="text-3xl md:text-5xl font-bold text-slate-900 tracking-tight leading-[1.1] font-display">
                                {title}
                            </h1>
                        </header>
                        
                        <!-- ä¸‰ä¸ªéš¾åº¦çš„æ–‡ç« å†…å®¹ -->
                        <article id="article-content" class="font-serif leading-loose text-lg text-slate-800/90 md:text-xl">
                            {sortedArticles.map((article: any) => {
                                const stats = getReadingStats(article.content);
                                
                                // [Structure] AST-Based Rendering
                                let astBlocks: any[] = [];
                                try {
                                    const parser = new StructureParser(article.content || '', article.structure || []);
                                    const ast = parser.parse();
                                    astBlocks = splitASTIntoBlocks(ast);
                                } catch (e) {
                                    console.error("[Structure] AST Parsing failed:", e);
                                    astBlocks = [[{ type: 'text', content: article.content || '' }]]; 
                                }

                                return (
                                    <div
                                        class="article-level"
                                        data-level={article.level}
                                        data-word-count={stats.wordCount}
                                        data-minutes={stats.minutes}
                                    >
                                        {astBlocks.map((blockNodes: any[], pIndex: number) => (
                                            <p 
                                                class={`mb-6 text-justify ${pIndex === 0 ? 'drop-cap-p' : 'indent-8'}`}
                                            >
                                                <StructuredText nodes={blockNodes} />
                                            </p>
                                        ))}
                                    </div>
                                );
                            })}
                        </article>
                    </div>
                    
                    <!-- æ¥æº -->
                    {sources.length > 0 && (
                        <div id="article-sources" class="pt-8 mt-8 border-t border-slate-900/10">
                            <div class="text-[10px] font-bold uppercase tracking-widest text-stone-500 mb-4">
                                Sources
                            </div>
                            <ul class="space-y-1">
                                {sources.map((url) => {
                                    let domain = url;
                                    try {
                                        domain = new URL(url).hostname.replace(/^www\./, "");
                                    } catch {}
                                    return (
                                        <li class="flex items-center gap-2">
                                            <span class="w-1 h-1 rounded-full bg-stone-300" />
                                            <a
                                                href={url}
                                                target="_blank"
                                                rel="noreferrer"
                                                class="text-xs font-serif text-stone-500 hover:text-slate-900 underline decoration-stone-300 underline-offset-4 hover:decoration-slate-900 transition-all"
                                                title={url}
                                            >
                                                {domain}
                                            </a>
                                        </li>
                                    );
                                })}
                            </ul>
                        </div>
                    )}
                    
                    <VisualTether client:only="react" />
                </div>
                
                <!-- Memory Spirit -->
                <MemorySpirit client:load />

                <!-- é«˜äº®ç®¡ç†å™¨ -->
                <HighlightManager 
                    client:load 
                    articleId={id} 
                    targetWords={targetWords}
                    wordMatchConfigs={wordMatchConfigs}
                    memoriesMap={memories}
                />

                {/* æ‚¬æµ®æ’­æ”¾å™¨ */}
                <FloatingAudioPlayer client:only="react" />
            </main>
            
            <!-- ä¾§è¾¹æ  -->
            {sidebarWords.length > 0 && (
                <aside class="lg:w-80 lg:shrink-0">
                    <div class="lg:sticky lg:top-6 space-y-4">
                        <AudioInit 
                            client:idle 
                            allContent={allArticleContents} 
                        />
                        {/* AudioPlayer Removed */}
                        <WordSidebarAstro words={sidebarWords} />
                    </div>
                </aside>
            )}
        </div>
    ) : (
        <div class="mx-auto w-full max-w-7xl px-4 py-10">
            <div class="rounded-xl border border-black/10 bg-white/60 p-5 text-sm opacity-70">
                è¯¥æ–‡ç« ä¸å­˜åœ¨æˆ–æœªå‘å¸ƒã€‚
            </div>
        </div>
    )}
</Layout>

<style is:global>
    /* å¼ºåŠ›è¦†ç›–ï¼šç¡®ä¿æœ—è¯»æ—¶çš„é«˜äº®ä¼˜å…ˆçº§æœ€é«˜ */
    span.w-token.bg-orange-200 {
        background-color: #fed7aa !important;
        color: #7c2d12 !important;
        box-shadow: 0 0 0 2px #fed7aa;
        border-radius: 2px;
        position: relative;
        z-index: 10;
    }
</style>

<style>
    /* é»˜è®¤åªæ˜¾ç¤º Level 1 */
    .article-level {
        opacity: 0;
        visibility: hidden;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        transition: opacity 0.5s ease;
        z-index: 1;
        pointer-events: none;
    }
    .article-level[data-active] {
        opacity: 1;
        visibility: visible;
        position: relative;
        z-index: 2;
        pointer-events: auto;
    }
    
    /* å®¹å™¨åŠ¨ç”» */
    #article-content {
        position: relative;
        transition: height 0.5s ease;
        min-height: 200px; 
    }
    
    /* éš¾åº¦æŒ‰é’®æ¿€æ´»çŠ¶æ€ */
    .level-btn[data-active] {
        background-color: rgb(15 23 42);
        color: white;
        border-color: rgb(15 23 42);
    }
    
    /* ç›®æ ‡å•è¯é«˜äº® */
    .target-word {
        color: #ea580c;
        font-weight: 600;
        border-bottom: 2px dotted #ea580c;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
    }

    /* Golden Soul Pin */
    .target-word[data-has-history="true"] {
        border-bottom-color: #f59e0b;
    }
    
    .target-word[data-has-history="true"]::after {
        content: '';
        position: absolute;
        top: -2px;
        right: -4px;
        width: 4px;
        height: 4px;
        background: #fbbf24;
        border-radius: 99px;
        box-shadow: 0 0 8px rgba(251, 191, 36, 0.6);
        opacity: 0.8;
    }
</style>

<script>
    // å¯¼å…¥æ‹†åˆ†åçš„æ¨¡å—
    import { initLevelSwitcher } from '../../lib/features/levelSwitcher';
    import { initReadTracker, trackReading } from '../../lib/features/readTracker';
    import { initStructureInteraction } from '../../lib/features/structure/interaction';

    function initArticlePage() {
        // åˆå§‹åŒ–éš¾åº¦åˆ‡æ¢
        initLevelSwitcher();
        
        // åˆå§‹åŒ–é˜…è¯»è¿½è¸ª
        initReadTracker();
        
        // ç›‘å¬éš¾åº¦å˜åŒ–ä»¥è§¦å‘é˜…è¯»è¿½è¸ª
        window.addEventListener('level-change', () => {
            trackReading();
        });
    }

    // æ”¯æŒæ™®é€šé¡µé¢åŠ è½½å’Œ View Transitions
    document.addEventListener('DOMContentLoaded', initArticlePage);
    document.addEventListener('astro:page-load', initArticlePage);

    // Structure Interaction
    document.addEventListener('DOMContentLoaded', initStructureInteraction);
    document.addEventListener('astro:page-load', initStructureInteraction);
</script>
