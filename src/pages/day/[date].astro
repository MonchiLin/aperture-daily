---
/**
 * 日期页面 - SSR 渲染
 * 
 * 每个日期对应一个 URL，完整服务端渲染。
 * View Transitions 提供平滑的页面切换体验。
 */
import Layout from "@/layouts/Layout.astro";
import MacOSCalendarAstro from "@/components/MacOSCalendar.astro";
import DayFeed from "@/components/DayFeed";
import { apiFetch } from "@/lib/api";

// 获取路由参数
const { date } = Astro.params;

// 验证日期格式
const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
if (!date || !dateRegex.test(date)) {
    return Astro.redirect('/');
}

// 性能计时辅助函数
const timedFetch = async <T>(name: string, fn: () => Promise<T>): Promise<T> => {
    const start = performance.now();
    try {
        const result = await fn();
        console.log(`[SSR-PERF] ${name}: ${(performance.now() - start).toFixed(2)}ms`);
        return result;
    } catch (e) {
        console.error(`[SSR-PERF] ${name}: ${(performance.now() - start).toFixed(2)}ms (FAILED)`, e);
        throw e;
    }
};

const ssrStartTime = performance.now();
console.log(`[SSR-PERF] ========== Start SSR for /day/${date} ==========`);

// 服务端并发预取数据
const fetchDays = () => timedFetch('fetchDays (/api/days)', () => 
    apiFetch<{ days: string[] }>('/api/days')
).catch(e => {
    return { days: [] };
});

const fetchDayData = () => timedFetch(`fetchDayData (/api/day/${date})`, () =>
    apiFetch(`/api/day/${date}`)
).catch(e => {
    return { articles: [] };
});

const fetchWordData = () => timedFetch(`fetchWordData (/api/day/${date}/words)`, () =>
    apiFetch(`/api/day/${date}/words`)
).catch(e => {
    return { new_words: [], review_words: [], new_count: 0, review_count: 0 };
});

// Admin fetching logic
const adminKey = Astro.cookies.get('admin_key')?.value;
const fetchAdminData = async () => {
    if (!adminKey) {
        console.log(`[SSR-PERF] fetchAdminData: skipped (no admin key)`);
        return null;
    }
    const adminStart = performance.now();
    try {
        await timedFetch('authCheck (/api/auth/check)', () =>
            apiFetch('/api/auth/check', { token: adminKey })
        );
        const taskResponse = await timedFetch(`fetchTasks (/api/tasks?task_date=${date})`, () =>
            apiFetch<{ tasks: any[] }>(
                `/api/tasks?task_date=${encodeURIComponent(date)}`,
                { token: adminKey }
            )
        );
        console.log(`[SSR-PERF] fetchAdminData (total): ${(performance.now() - adminStart).toFixed(2)}ms`);
        return {
            isAdmin: true,
            tasks: taskResponse.tasks || []
        };
    } catch (e) {
        console.error(`[SSR-PERF] fetchAdminData: ${(performance.now() - adminStart).toFixed(2)}ms (FAILED)`, e);
        return null;
    }
};

// 执行并行请求
const [daysStats, dayDataResult, wordDataStats, adminDataResult] = await Promise.all([
    fetchDays(),
    fetchDayData(),
    fetchWordData(),
    fetchAdminData()
]);

console.log(`[SSR-PERF] ========== Total SSR time: ${(performance.now() - ssrStartTime).toFixed(2)}ms ==========`);

// 处理数据
const publishedDays = daysStats?.days || [];
const dayData = dayDataResult || { articles: [] };
const wordData = wordDataStats || { new_words: [], review_words: [], new_count: 0, review_count: 0 };
const adminData = adminDataResult;

// 设置缓存策略 (仅在有内容且非 Admin 登录状态下严格缓存?? 其实 Admin 状态下为了实时性可能不想缓存，但这里主要看有没有文章)
// 注意：如果 adminData 存在，可能是管理员在查看，管理员可能希望能看到实时数据? 
// 但目前的逻辑是根据 articles 来定。
if (dayData.articles?.length > 0) {
    // 5分钟新鲜度，1小时宽容度 (提升并行效率后，即使回源也很快)
    Astro.response.headers.set('Cache-Control', 'public, s-maxage=300, stale-while-revalidate=3600');
} else {
    Astro.response.headers.set('Cache-Control', 'no-store');
}
---

<Layout title={`${date} - Aperture Daily`}>
    <div class="relative w-full max-w-7xl mx-auto px-4 py-8 md:py-12">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-12 items-start">
            <!-- 左侧日历 - 纯 Astro 组件，零 JS -->
            <div class="md:col-span-4 lg:col-span-4 sticky top-24">
                <MacOSCalendarAstro
                    publishedDays={publishedDays}
                    selectedDate={date}
                />
            </div>

            <!-- 右侧文章列表 - SSR 输出完整 HTML -->
            <div 
                class="md:col-span-8 lg:col-span-8 min-h-[500px]"
                transition:animate="slide"
            >
                <!-- 文章列表 - React 组件 (支持 SSR) -->
                <DayFeed 
                    client:load 
                    date={date} 
                    initialArticles={dayData.articles} 
                    wordData={wordData}
                    adminData={adminData}
                />
            </div>
        </div>
    </div>
</Layout>

