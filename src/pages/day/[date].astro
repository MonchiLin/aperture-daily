---
/**
 * æ—¥æœŸé¡µé¢ - SSR æ¸²æŸ“
 * 
 * æ¯ä¸ªæ—¥æœŸå¯¹åº”ä¸€ä¸ª URLï¼Œå®Œæ•´æœåŠ¡ç«¯æ¸²æŸ“ã€‚
 * View Transitions æä¾›å¹³æ»‘çš„é¡µé¢åˆ‡æ¢ä½“éªŒã€‚
 * 
 * ğŸï¸ ç»„ä»¶æ‹†åˆ†æ¶æ„ï¼š
 *   - DayHeader.astro - æ—¥æœŸå¤´éƒ¨ (çº¯ SSR)
 *   - ArticleList.astro - æ–‡ç« åˆ—è¡¨ (SSR é¦–å± + noscript å…œåº•)
 *   - ArticleListClient - æ–‡ç« åˆ—è¡¨ (å®¢æˆ·ç«¯åŠ¨æ€æ›´æ–°)
 *   - DayStateSync - çŠ¶æ€åŒæ­¥ (è½»é‡å­¤å²›)
 *   - WordsDrawer - è¯æ±‡æŠ½å±‰ (å­¤å²›)
 *   - AdminDrawer - ç®¡ç†æŠ½å±‰ (æ¡ä»¶å­¤å²›)
 */
import Layout from "@/layouts/Layout.astro";
import MacOSCalendarAstro from "@/components/MacOSCalendar.astro";
import DayHeader from "@/components/day/DayHeader.astro";
import ArticleList from "@/components/day/ArticleList.astro";
import ArticleListClient from "@/components/day/ArticleListClient";
import DayStateSync from "@/components/day/DayStateSync";
import WordsDrawer from "@/components/WordsDrawer";
import AdminDrawer from "@/components/AdminDrawer";
import { apiFetch } from "@/lib/api";

// è·å–è·¯ç”±å‚æ•°
const { date } = Astro.params;

// éªŒè¯æ—¥æœŸæ ¼å¼
const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
if (!date || !dateRegex.test(date)) {
    return Astro.redirect('/');
}

// æœåŠ¡ç«¯å¹¶å‘é¢„å–æ•°æ®
const fetchDays = () => apiFetch<{ days: string[] }>('/api/days').catch(e => {
    console.error("[SSR] Failed to fetch days:", e);
    return { days: [] };
});

const fetchDayData = () => apiFetch(`/api/day/${date}`).catch(e => {
    console.error(`[SSR] Failed to fetch day data for ${date}:`, e);
    return { articles: [] };
});

const fetchWordData = () => apiFetch(`/api/day/${date}/words`).catch(e => {
    console.error(`[SSR] Failed to fetch word data for ${date}:`, e);
    return { new_words: [], review_words: [], new_count: 0, review_count: 0 };
});

// Admin fetching logic
const adminKey = Astro.cookies.get('admin_key')?.value;
const fetchAdminData = async () => {
    if (!adminKey) return null;
    try {
        await apiFetch('/api/auth/check', { token: adminKey });
        const taskResponse = await apiFetch<{ tasks: any[] }>(
            `/api/tasks?task_date=${encodeURIComponent(date)}`,
            { token: adminKey }
        );
        return {
            isAdmin: true,
            tasks: taskResponse.tasks || []
        };
    } catch (e) {
        console.error("[SSR] Admin auth failed:", e);
        return null;
    }
};

// æ‰§è¡Œå¹¶è¡Œè¯·æ±‚
const [daysStats, dayDataResult, wordDataStats, adminDataResult] = await Promise.all([
    fetchDays(),
    fetchDayData(),
    fetchWordData(),
    fetchAdminData()
]);

// å¤„ç†æ•°æ®
const publishedDays = daysStats?.days || [];
const dayData = dayDataResult || { articles: [] };
const wordData = wordDataStats || { new_words: [], review_words: [], new_count: 0, review_count: 0 };
const adminData = adminDataResult;

// ğŸ”‘ SSR æƒé™åˆ¤æ–­ - å†³å®šæ˜¯å¦æ¸²æŸ“ç®¡ç†å­¤å²›
const isAdmin = !!adminData?.isAdmin;

// è®¾ç½®ç¼“å­˜ç­–ç•¥
if (dayData.articles?.length > 0) {
    // 5åˆ†é’Ÿæ–°é²œåº¦ï¼Œ1å°æ—¶å®½å®¹åº¦
    Astro.response.headers.set('Cache-Control', 'public, s-maxage=300, stale-while-revalidate=3600');
} else {
    Astro.response.headers.set('Cache-Control', 'no-store');
}
---

<Layout title={`${date} - UpWord`}>
    <div class="relative w-full max-w-7xl mx-auto px-4 py-8 md:py-12">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-12 items-start">
            <!-- å·¦ä¾§æ—¥å† - çº¯ Astro ç»„ä»¶ï¼Œé›¶ JS -->
            <div class="md:col-span-4 lg:col-span-4 sticky top-24">
                <MacOSCalendarAstro
                    publishedDays={publishedDays}
                    selectedDate={date}
                />
            </div>

            <!-- å³ä¾§æ–‡ç« åˆ—è¡¨ -->
            <div 
                class="md:col-span-8 lg:col-span-8 min-h-[500px] font-serif text-slate-900"
                transition:animate="slide"
            >
                <!-- ğŸï¸ çŠ¶æ€åŒæ­¥å­¤å²› (ä¸å¯è§ï¼Œä»…åŒæ­¥æ•°æ®) -->
                <DayStateSync 
                    client:load 
                    date={date} 
                    articles={dayData.articles}
                    adminData={adminData}
                />

                <!-- æ—¥æœŸå¤´éƒ¨ (çº¯ SSR) -->
                <DayHeader date={date}>
                    <Fragment slot="actions">
                        <!-- ğŸï¸ è¯æ±‡æŠ½å±‰å­¤å²› -->
                        <WordsDrawer client:idle date={date} wordData={wordData} />
                        <!-- ğŸï¸ ç®¡ç†æŠ½å±‰å­¤å²› (æ¡ä»¶æ¸²æŸ“) -->
                        {isAdmin && (
                            <AdminDrawer 
                                client:idle 
                                date={date} 
                                initialTasks={adminData?.tasks}
                            />
                        )}
                    </Fragment>
                </DayHeader>

                <!-- æ–‡ç« åˆ—è¡¨ï¼šSSR é¦–å± + å®¢æˆ·ç«¯æ¥ç®¡ -->
                <!-- SSR ç‰ˆæœ¬ï¼šé¦–å±æ¸²æŸ“ï¼Œå®¢æˆ·ç«¯ hydration åéšè— -->
                <div class="article-list-ssr">
                    <ArticleList articles={dayData.articles} date={date} />
                </div>
                <!-- å®¢æˆ·ç«¯ç‰ˆæœ¬ï¼šhydration åæ˜¾ç¤ºï¼Œæ”¯æŒåŠ¨æ€æ›´æ–° -->
                <div class="article-list-client">
                    <ArticleListClient client:idle date={date} initialArticles={dayData.articles} />
                </div>

                <style>
                    /* é»˜è®¤æ˜¾ç¤º SSR ç‰ˆæœ¬ */
                    .article-list-ssr { display: block; }
                    .article-list-client { display: none; }
                    
                    /* å®¢æˆ·ç«¯ hydration ååˆ‡æ¢æ˜¾ç¤º */
                    :global(html.hydrated) .article-list-ssr { display: none; }
                    :global(html.hydrated) .article-list-client { display: block; }
                </style>
            </div>
        </div>
    </div>
</Layout>

