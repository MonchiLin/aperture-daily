---
/**
 * 日期页面 - SSR 渲染
 * 
 * 每个日期对应一个 URL，完整服务端渲染。
 * View Transitions 提供平滑的页面切换体验。
 */
import Layout from "@/layouts/Layout.astro";
import MacOSCalendarAstro from "@/components/MacOSCalendar.astro";
import DayFeed from "@/components/DayFeed";
import { apiFetch } from "@/lib/api";

// 获取路由参数
const { date } = Astro.params;

// 验证日期格式
const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
if (!date || !dateRegex.test(date)) {
    return Astro.redirect('/');
}

// 服务端预取数据
let publishedDays: string[] = [];
let dayData: { articles: any[] } = { articles: [] };
let wordData: { new_words: string[]; review_words: string[]; new_count: number; review_count: number } = {
    new_words: [],
    review_words: [],
    new_count: 0,
    review_count: 0
};

// 管理员数据（从 Cookie 获取）
let adminData: { isAdmin: boolean; adminKey: string; tasks: any[] } | null = null;

try {
    const daysResponse = await apiFetch<{ days: string[] }>('/api/days');
    publishedDays = daysResponse.days || [];
} catch (e) {
    console.error("[SSR] Failed to fetch days:", e);
}

try {
    dayData = await apiFetch(`/api/day/${date}`);
    // 只有在有内容时才启用缓存
    if (dayData.articles?.length > 0) {
        // 有文章发布，启用 Cloudflare 边缘缓存 (5分钟)
        Astro.response.headers.set('Cache-Control', 'public, s-maxage=300, stale-while-revalidate=3600');
    } else {
        // 无内容（任务可能执行中），禁止缓存
        Astro.response.headers.set('Cache-Control', 'no-store');
    }
} catch (e) {
    console.error(`[SSR] Failed to fetch day data for ${date}:`, e);
    // 错误情况，禁止缓存
    Astro.response.headers.set('Cache-Control', 'no-store');
}

// 预取单词数据（SSR，长期缓存）
try {
    wordData = await apiFetch(`/api/day/${date}/words`);
} catch (e) {
    console.error(`[SSR] Failed to fetch word data for ${date}:`, e);
}

// 预取管理员数据（从 HttpOnly Cookie）
const adminKey = Astro.cookies.get('admin_key')?.value;
if (adminKey) {
    try {
        // 验证 Cookie 有效性
        await apiFetch('/api/auth/check', { token: adminKey });
        // 获取任务数据
        const taskResponse = await apiFetch<{ tasks: any[] }>(
            `/api/tasks?task_date=${encodeURIComponent(date)}`,
            { token: adminKey }
        );
        adminData = {
            isAdmin: true,
            adminKey,
            tasks: taskResponse.tasks || []
        };
    } catch (e) {
        // Cookie 无效，忽略
        console.error("[SSR] Admin auth failed:", e);
    }
}
---

<Layout title={`${date} - Aperture Daily`}>
    <div class="relative w-full max-w-7xl mx-auto px-4 py-8 md:py-12">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-12 items-start">
            <!-- 左侧日历 - 纯 Astro 组件，零 JS -->
            <div class="md:col-span-4 lg:col-span-4 sticky top-24">
                <MacOSCalendarAstro
                    publishedDays={publishedDays}
                    selectedDate={date}
                />
            </div>

            <!-- 右侧文章列表 - SSR 输出完整 HTML -->
            <div 
                class="md:col-span-8 lg:col-span-8 min-h-[500px]"
                transition:animate="slide"
            >
                <!-- 文章列表 - React 组件 (支持 SSR) -->
                <DayFeed 
                    client:load 
                    date={date} 
                    initialArticles={dayData.articles} 
                    wordData={wordData}
                    adminData={adminData}
                />
            </div>
        </div>
    </div>
</Layout>

