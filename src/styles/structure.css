/*
    Feature: Structure (Visual Layer)
    Version: 9.4 (Refactored & Variables)
    Hierarchy: [data-structure] > .s-token
*/

:root {
    /* --- Palette: Structure Colors --- */
    --st-color-subject-bg: #1e3a8a;
    --st-color-subject-shadow: #3b82f6;

    --st-color-verb-bg: #fee2e2;
    --st-color-verb-text: #991b1b;
    --st-color-verb-label: #7f1d1d;

    --st-color-object-bg: #064e3b;
    --st-color-object-shadow: #10b981;

    --st-color-conn-text: #d97706;
    --st-color-conn-label: #78350f;

    --st-color-rc-bg: rgba(241, 245, 249, 0.8);
    --st-color-rc-border: #94a3b8;
    --st-color-rc-label-bg: #334155;
    --st-color-rc-label-text: #f1f5f9;

    --st-color-passive-deco: #f97316;
    --st-color-passive-label: #c2410c;

    --st-color-pp-text: #64748b;
    --st-color-pp-border: #cbd5e1;
    --st-color-pp-label: #475569;

    /* New: Complement */
    --st-color-cmp-bg: #ede9fe;
    --st-color-cmp-text: #6d28d9;

    /* New: Adverbial */
    --st-color-adv-text: #0369a1;
    --st-color-adv-border: #0ea5e9;

    /* New: Appositive */
    --st-color-app-bg: #ecfeff;
    --st-color-app-border: #06b6d4;

    /* New: Infinitive */
    --st-color-inf-text: #be185d;
    --st-color-inf-deco: #ec4899;

    /* New: Gerund */
    --st-color-ger-bg: #fdf2f8;
    --st-color-ger-text: #9d174d;

    /* New: Participle */
    --st-color-ptc-text: #831843;
    --st-color-ptc-deco: #f472b6;

    /* New: Indirect Object */
    --st-color-io-shadow: #10b981;

    /* --- UI States --- */
    --st-ui-active-bg: rgba(254, 243, 199, 0.5);
    /* Amber-100/50 */
    --st-ui-hover-bg: rgba(0, 0, 0, 0.04);
}

/* Base Structure Element */
[data-structure] {
    position: relative;
    display: inline;
    transition: all 0.2s ease;
    text-decoration: none;
    border-bottom: none;
}

.s-token {
    cursor: pointer;
    transition: background-color 0.15s ease;
    border-radius: 2px;
}

.s-token.sentence-hover {
    background-color: var(--st-ui-hover-bg);
}

.s-token.structure-active {
    background-color: var(--st-ui-active-bg);
}

/* --- 2. Structure Labels (JS-positioned) --- */
/* 
 * Labels are now created by JavaScript (labelPositioner.ts)
 * for dynamic collision detection and avoidance.
 * The ::after approach is removed as CSS cannot detect sibling collisions.
 */
.structure-label {
    position: absolute;
    z-index: 100;

    /* Metrics */
    padding: 2px 6px;
    border-radius: 3px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);

    /* Typography */
    font-family: ui-sans-serif, system-ui, sans-serif;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    line-height: 1;
    white-space: nowrap;

    /* Color from JS via CSS variable */
    background-color: var(--label-color, #1e293b);
    color: #ffffff;
    pointer-events: none;

    /* Animation */
    opacity: 0;
    transform: translateY(4px);
    animation: labelFadeIn 0.15s ease-out forwards;
}

@keyframes labelFadeIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* --- 3. Label colors are now handled by labelPositioner.ts via CSS variables --- */

/* --- 4. Role-Specific Highlighting (Layout Safe) --- */

/* Subject -> Underline Shadow */
[data-structure="s"]:has(.structure-active),
[data-structure="subject"]:has(.structure-active) {
    box-shadow: 0 -2px 0 0 var(--st-color-subject-shadow);
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* --- Interactive Opacity Swap (Variant B: Semantic Focus) --- */
/* Ensure transitions apply to clip-path */
.structure-label {
    transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1), clip-path 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    transform-origin: center center;
    backface-visibility: hidden;
}

/* Hidden Children (Depth 1) - Dot Mode */
.structure-connector.st-depth-1 {
    opacity: 0 !important;
}

.structure-label.st-depth-1 {
    opacity: 0.8 !important;
    /* Layout: Keep original dimensions */
    color: transparent !important;
    /* Dot at Center */
    clip-path: circle(3px at center);

    transform: translateY(10px) scale(1);
    filter: none;
    pointer-events: auto !important;
    z-index: 50 !important;
    cursor: help;
}

/* Parent Fading Out */
.structure-label.st-fade-out {
    opacity: 0 !important;
    transform: translateY(-8px) scale(0.95);
    filter: blur(2px);
}

/* Children Fading In - Expand from Center */
.structure-label.st-fade-in,
.structure-connector.st-fade-in {
    opacity: 1 !important;
    transform: translateY(0) scale(1);
    filter: none;

    /* Animate clip-path to reveal full label from center */
    clip-path: circle(150% at center) !important;
    /* Expansion animation */

    color: white !important;
    pointer-events: auto !important;
    z-index: 100 !important;
    cursor: default;
}

/* Verb -> Red Background & Text */
[data-structure="v"]:has(.structure-active),
[data-structure="verb"]:has(.structure-active) {
    background-color: var(--st-color-verb-bg);
    color: var(--st-color-verb-text) !important;
    font-weight: 500;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Object -> Underline Shadow */
[data-structure="o"]:has(.structure-active),
[data-structure="object"]:has(.structure-active) {
    box-shadow: 0 2px 0 0 var(--st-color-object-shadow);
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Indirect Object -> Green Underline Shadow */
[data-structure="io"]:has(.structure-active),
[data-structure="indirect-object"]:has(.structure-active) {
    box-shadow: 0 2px 0 0 var(--st-color-io-shadow);
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Connective -> Dotted Underline */
[data-structure="con"]:has(.structure-active),
[data-structure="connective"]:has(.structure-active) {
    color: var(--st-color-conn-text) !important;
    font-weight: 500;
    font-size: 0.9em;
    text-decoration: underline dotted var(--st-color-conn-text);
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Relative Clause -> Dashed Box */
[data-structure="rc"]:has(.structure-active),
[data-structure="rel-clause"]:has(.structure-active) {
    background-color: var(--st-color-rc-bg);
    outline: 1px dashed var(--st-color-rc-border);
    border-radius: 2px;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Passive -> Wavy Underline */
[data-structure="pas"]:has(.structure-active),
[data-structure="passive"]:has(.structure-active) {
    font-style: italic;
    text-decoration: underline wavy var(--st-color-passive-deco);
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Prepositional Phrase -> Light Text */
[data-structure="pp"]:has(.structure-active),
[data-structure="prep-phrase"]:has(.structure-active) {
    color: var(--st-color-pp-text);
    border-bottom: 1px dotted var(--st-color-pp-border);
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Complement -> Purple Background */
[data-structure="cmp"]:has(.structure-active),
[data-structure="complement"]:has(.structure-active) {
    background-color: var(--st-color-cmp-bg);
    color: var(--st-color-cmp-text) !important;
    font-weight: 500;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Adverbial -> Blue Underline */
[data-structure="adv"]:has(.structure-active),
[data-structure="adverbial"]:has(.structure-active) {
    color: var(--st-color-adv-text);
    border-bottom: 2px solid var(--st-color-adv-border);
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Appositive -> Cyan Box */
[data-structure="app"]:has(.structure-active),
[data-structure="appositive"]:has(.structure-active) {
    background-color: var(--st-color-app-bg);
    border: 1px dashed var(--st-color-app-border);
    border-radius: 2px;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Infinitive -> Pink Dotted Underline */
[data-structure="inf"]:has(.structure-active),
[data-structure="infinitive"]:has(.structure-active) {
    color: var(--st-color-inf-text) !important;
    text-decoration: underline dotted var(--st-color-inf-deco);
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Gerund -> Pink Background */
[data-structure="ger"]:has(.structure-active),
[data-structure="gerund"]:has(.structure-active) {
    background-color: var(--st-color-ger-bg);
    color: var(--st-color-ger-text) !important;
    font-weight: 500;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* Participle -> Rose Underline */
[data-structure="ptc"]:has(.structure-active),
[data-structure="participle"]:has(.structure-active) {
    color: var(--st-color-ptc-text) !important;
    text-decoration: underline wavy var(--st-color-ptc-deco);
    font-style: italic;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

/* --- 5. Compatibility --- */
/* Ensure target words (yellow/orange) are still visible when inside Structure highlights */
.target-word:has(.structure-active) {
    color: #ea580c !important;
    /* Orange-600 */
    font-weight: 500;
    text-decoration: underline;
    text-decoration-color: #ea580c;
    text-decoration-thickness: 1.5px;
}